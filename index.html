<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Piano & Drum Studio</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,Arial;background:linear-gradient(180deg,#061226 0%, #071430 100%);color:#e6eef8}
    .app{max-width:1100px;margin:28px auto;padding:22px;display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
    button.active{background:linear-gradient(90deg,var(--accent),#5b21b6);color:white}
    .row{display:flex;gap:10px;align-items:center}
    .panel{padding:12px}
    .keyboard{display:flex;user-select:none}
    .key{width:48px;height:160px;border-radius:6px;margin:0 3px;position:relative;display:flex;align-items:flex-end;justify-content:center;box-shadow:inset 0 -6px 12px rgba(0,0,0,0.35);cursor:pointer}
    .white{background:#f7fafc;color:#081425}
    .black{width:36px;height:110px;background:#0f1724;color:white;z-index:2;margin-left:-18px;margin-right:-18px;border-radius:4px;box-shadow:0 6px 12px rgba(2,6,23,0.6)}
    .key-label{font-size:12px;margin-bottom:8px;opacity:0.85}
    .drum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pad{height:68px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .pad.kick{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .pad.snare{background:linear-gradient(180deg,#10b981,#047857)}
    .pad.hat{background:linear-gradient(180deg,#f59e0b,#92400e)}
    .sequencer{display:grid;grid-template-columns:repeat(16,1fr);gap:6px;margin-top:10px}
    .step{height:28px;border-radius:6px;background:rgba(255,255,255,0.03);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .step.on{background:linear-gradient(90deg,var(--accent),#4c1d95)}
    .meter{height:6px;width:100%;background:rgba(255,255,255,0.04);border-radius:6px}
    .meter > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#06b6d4);border-radius:6px}
    .info{font-size:13px;color:var(--muted)}
    .footer{font-size:12px;color:var(--muted);margin-top:8px}
    .slider{width:140px}
    .kbd-hint{font-size:12px;color:var(--muted);margin-top:8px}
    @media (max-width: 980px) {
  .app {
    grid-template-columns: 1fr;
  }
}

/* ✅ Mobile responsiveness */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    align-items: flex-start;
  }

  .controls {
    flex-direction: column;
    align-items: stretch;
  }

  .keyboard {
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .key.white {
    width: 40px;
    height: 140px;
  }

  .key.black {
    width: 28px;
    height: 95px;
    margin-left: -14px;
    margin-right: -14px;
  }

  .row {
    flex-direction: column;
  }

  .pad {
    height: 60px;
    font-size: 14px;
  }

  .sequencer {
    grid-template-columns: repeat(8, 1fr);
  }

  .step {
    height: 36px;
  }
}

@media (max-width: 480px) {
  h1 {
    font-size: 16px;
  }

  .key.white {
    width: 36px;
    height: 120px;
  }

  .key.black {
    width: 24px;
    height: 80px;
    margin-left: -12px;
    margin-right: -12px;
  }

  .pad {
    height: 54px;
    font-size: 13px;
  }

  .sequencer {
    grid-template-columns: repeat(4, 1fr);
  }
}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>Piano & Drum Studio</h1>
        <div class="info">Play with mouse or keyboard — record, loop and export the session.</div>
      </header>

      <div class="panel">
        <div class="row controls">
          <button id="playBtn">Play</button>
          <button id="stopBtn">Stop</button>
          <button id="recordBtn">Record</button>
          <button id="clearBtn">Clear Recording</button>
          <label style="display:flex;align-items:center;gap:6px"><span class="info">Tempo</span><input id="tempo" class="slider" type="range" min="60" max="180" value="120"></label>
          <label style="display:flex;align-items:center;gap:6px"><span class="info">Volume</span><input id="volume" class="slider" type="range" min="0" max="1" step="0.01" value="0.9"></label>
        </div>

        <section style="margin-top:14px">
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div style="flex:1">
              <div class="info">Piano (keys: A W S E D F T G Y H U J) — click or press</div>
              <div id="keyboard" class="keyboard" style="margin-top:8px"></div>
            </div>

            <div style="width:320px">
              <div class="info">Drum Pads</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                <div class="pad kick card" id="pad-kick">Kick</div>
                <div class="pad snare card" id="pad-snare">Snare</div>
                <div class="pad hat card" id="pad-hat">Hi-Hat</div>
                <div class="pad" style="background:linear-gradient(180deg,#60a5fa,#1e40af)" id="pad-clap">Clap</div>
              </div>

              <div style="margin-top:12px">
                <div class="info">Drum Sequencer (16 steps)</div>
                <div style="display:grid;gap:8px;margin-top:8px">
                  <div><strong class="info">Kick</strong>
                    <div id="seq-kick" class="sequencer"></div>
                  </div>
                  <div><strong class="info">Snare</strong>
                    <div id="seq-snare" class="sequencer"></div>
                  </div>
                  <div><strong class="info">Hat</strong>
                    <div id="seq-hat" class="sequencer"></div>
                  </div>
                  <div><strong class="info">Clap</strong>
                    <div id="seq-clap" class="sequencer"></div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <div class="footer">Tip: Click "Record" then play keys/pads. Press Play to loop the recorded sequence with tempo.</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div>
          <div class="info">Session Controls</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="downloadJSON">Export JSON</button>
            <button id="importJSON">Import JSON</button>
            <input id="fileInput" type="file" accept="application/json" style="display:none">
          </div>
        </div>

        <div>
          <div class="info">Metronome</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="metBtn">Toggle Metronome</button>
            <label class="info">Subdivision: <select id="subdiv"><option value="4">4 (quarter)</option><option value="8">8 (8th)</option><option value="16" selected>16 (16th)</option></select></label>
          </div>
        </div>

        <div>
          <div class="info">Recording</div>
          <div style="margin-top:8px"><div class="meter"><i id="recMeter"></i></div></div>
        </div>

        <div>
          <div class="info">Keyboard Mappings</div>
          <div class="kbd-hint">Piano: A W S E D F T G Y H U J | Drum pads: K (kick), L (snare), ; (hat)</div>
        </div>
      </div>
    </div>
  </div>

<script>
// --- Audio setup ---
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioCtx();
let masterGain = ctx.createGain(); masterGain.gain.value = 0.9; masterGain.connect(ctx.destination);

// utility envelope
function playPianoNote(freq, time=0, velocity=1){
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  // add a bit of detuned saw for warmth
  const osc2 = ctx.createOscillator(); osc2.type='sawtooth'; osc2.frequency.value = freq*2; osc2.detune.value = -12;
  const mix = ctx.createGain(); mix.gain.value = 0.18;

  const env = ctx.createGain();
  env.gain.value = 0.0001;
  const now = ctx.currentTime + time;
  env.gain.cancelScheduledValues(now);
  env.gain.setValueAtTime(0.0001, now);
  env.gain.exponentialRampToValueAtTime(Math.max(0.001, velocity), now + 0.01);
  env.gain.exponentialRampToValueAtTime(0.0005, now + 1.8);

  o.connect(env);
  osc2.connect(mix); mix.connect(env);
  env.connect(g);
  g.connect(masterGain);
  o.start(now); osc2.start(now);
  o.stop(now + 2.2); osc2.stop(now + 2.2);
}

// drums: synthesized
function playKick(time=0, velocity=1){
  const now = ctx.currentTime + time;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(150, now);
  o.frequency.exponentialRampToValueAtTime(50, now + 0.2);
  g.gain.setValueAtTime(1*velocity, now);
  g.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
  o.connect(g); g.connect(masterGain); o.start(now); o.stop(now + 0.6);
}
function playSnare(time=0, velocity=1){
  const now = ctx.currentTime + time;
  // noise
  const bufferSize = 2*ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++) output[i] = Math.random()*2-1;
  const noise = ctx.createBufferSource(); noise.buffer = noiseBuffer;
  const noiseFilter = ctx.createBiquadFilter(); noiseFilter.type='bandpass'; noiseFilter.frequency.value = 2000;
  const g = ctx.createGain(); g.gain.setValueAtTime(1*velocity, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.2);
  noise.connect(noiseFilter); noiseFilter.connect(g); g.connect(masterGain);
  noise.start(now); noise.stop(now + 0.3);
}
function playHat(time=0, velocity=1){
  const now = ctx.currentTime + time;
  const bufferSize = 0.5*ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++) output[i] = Math.random()*2-1;
  const noise = ctx.createBufferSource(); noise.buffer = noiseBuffer;
  const f = ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value = 7000;
  const g = ctx.createGain(); g.gain.setValueAtTime(0.7*velocity, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
  noise.connect(f); f.connect(g); g.connect(masterGain);
  noise.start(now); noise.stop(now + 0.12);
}
function playClap(time=0, velocity=1){
  const now = ctx.currentTime + time;
  const bufferSize = 1*ctx.sampleRate;
  const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const output = noiseBuffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++) output[i] = (Math.random()*2-1)*Math.exp(-i/(bufferSize/10));
  const noise = ctx.createBufferSource(); noise.buffer = noiseBuffer;
  const g = ctx.createGain(); g.gain.setValueAtTime(0.8*velocity, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
  noise.connect(g); g.connect(masterGain);
  noise.start(now); noise.stop(now + 0.5);
}

// --- UI build: piano keys ---
const keyboard = document.getElementById('keyboard');
// choose a range: C4 to B5 (two octaves)
const keyMap = [
  {note:'C4',k:'A',midi:60}, {note:'C#4',k:'W',midi:61,black:true}, {note:'D4',k:'S',midi:62}, {note:'D#4',k:'E',midi:63,black:true}, {note:'E4',k:'D',midi:64},
  {note:'F4',k:'F',midi:65}, {note:'F#4',k:'T',midi:66,black:true}, {note:'G4',k:'G',midi:67}, {note:'G#4',k:'Y',midi:68,black:true}, {note:'A4',k:'H',midi:69},
  {note:'A#4',k:'U',midi:70,black:true}, {note:'B4',k:'J',midi:71}, {note:'C5',k:'K',midi:72}
];

function midiToFreq(m){return 440 * Math.pow(2,(m-69)/12);} 

keyMap.forEach(k=>{
  const el = document.createElement('div'); el.classList.add('key'); el.classList.add(k.black? 'black': 'white');
  el.innerHTML = `<div class=\"key-label\">${k.k}<br><strong>${k.note}</strong></div>`;
  el.addEventListener('mousedown', ()=>{triggerPiano(k.midi,1)});
  keyboard.appendChild(el);
  k.el = el;
});

// --- Drum pad handlers ---
document.getElementById('pad-kick').addEventListener('mousedown', ()=>triggerDrum('kick'));
document.getElementById('pad-snare').addEventListener('mousedown', ()=>triggerDrum('snare'));
document.getElementById('pad-hat').addEventListener('mousedown', ()=>triggerDrum('hat'));
document.getElementById('pad-clap').addEventListener('mousedown', ()=>triggerDrum('clap'));

// sequencer UI
function makeSequencer(containerId){
  const cont = document.getElementById(containerId);
  for(let i=0;i<16;i++){
    const s = document.createElement('div'); s.className='step'; s.dataset.index=i;
    s.addEventListener('click', ()=>{s.classList.toggle('on');});
    cont.appendChild(s);
  }
}
makeSequencer('seq-kick'); makeSequencer('seq-snare'); makeSequencer('seq-hat'); makeSequencer('seq-clap');

// --- State & transport ---
let isPlaying=false, isRecording=false, currentStep=0, metro=false;
let tempoEl = document.getElementById('tempo');
let subdivEl = document.getElementById('subdiv');
let playBtn = document.getElementById('playBtn');
let stopBtn = document.getElementById('stopBtn');
let recordBtn = document.getElementById('recordBtn');
let recMeter = document.getElementById('recMeter');
let volume = document.getElementById('volume'); volume.addEventListener('input', ()=>masterGain.gain.value = Number(volume.value));

playBtn.addEventListener('click', ()=>{start();});
stopBtn.addEventListener('click', ()=>{stop();});
recordBtn.addEventListener('click', ()=>{toggleRecord();});

function start(){
  if(!isPlaying){
    isPlaying=true; currentStep=0; scheduleLoop();
  }
}
function stop(){
  isPlaying=false; currentStep=0; if(schedulerId) cancelAnimationFrame(schedulerId);
}

function toggleRecord(){
  isRecording = !isRecording; recordBtn.classList.toggle('active', isRecording);
  if(isRecording){ recordedEvents = []; recMeter.style.width='100%'; } else { recMeter.style.width='0%'; }
}

document.getElementById('clearBtn').addEventListener('click', ()=>{recordedEvents=[]; alert('Recording cleared');});

// recording storage
let recordedEvents = []; // {type:'piano'/'drum', note:, time:timestamp}

// keyboard events
window.addEventListener('keydown',(e)=>{
  if(e.repeat) return;
  const key = e.key.toUpperCase();
  // piano
  const found = keyMap.find(k=>k.k===key);
  if(found){ triggerPiano(found.midi,1); found.el.classList.add('active'); setTimeout(()=>found.el.classList.remove('active'),120); }
  // drums
  if(key==='K') triggerDrum('kick');
  if(key==='L') triggerDrum('snare');
  if(key===';') triggerDrum('hat');
});

function triggerPiano(midi,velocity=1){
  if(ctx.state === 'suspended') ctx.resume();
  playPianoNote(midiToFreq(midi),0,velocity);
  if(isRecording){ recordedEvents.push({type:'piano', midi, t: performance.now()}); }
}
function triggerDrum(name,velocity=1){
  if(ctx.state === 'suspended') ctx.resume();
  if(name==='kick') playKick(0,velocity);
  if(name==='snare') playSnare(0,velocity);
  if(name==='hat') playHat(0,velocity);
  if(name==='clap') playClap(0,velocity);
  if(isRecording){ recordedEvents.push({type:'drum', drum:name, t: performance.now()}); }
}

// --- Sequencer / scheduler ---
let lastScheduleTime = 0; let schedulerId = null;
function scheduleLoop(){
  const bpm = Number(tempoEl.value);
  const subdivision = Number(subdivEl.value); // e.g., 16
  const stepDuration = (60 / bpm) / (subdivision/4); // step for 16 -> quarter/(16/4)=quarter/4 = 16th
  const lookahead = 0.1; // seconds
  const scheduleAhead = 0.2; // seconds
  lastScheduleTime = ctx.currentTime;

  function tick(){
    if(!isPlaying) return;
    const now = ctx.currentTime;
    // compute step index based on time
    const beatTime = 60/bpm; // seconds per quarter
    // We'll schedule next 0.2s of audio
    let scheduleTime = now;
    // schedule steps up to scheduleAhead
    while (lastScheduleTime < now + scheduleAhead){
      const elapsedBeats = (lastScheduleTime - now) / beatTime;
      // convert to step index using subdivision
      const total16ths = Math.round((lastScheduleTime - startTime) / (beatTime/4) );
      // but simpler: maintain step counter
      scheduleStep(lastScheduleTime);
      lastScheduleTime += stepDuration;
    }
    schedulerId = requestAnimationFrame(tick);
  }

  // simpler implementation: use setInterval scheduling at stepDuration
  if(window._stepInterval) clearInterval(window._stepInterval);
  let step = 0; const steps = 16;
  const start = Date.now();
  window._stepInterval = setInterval(()=>{
    if(!isPlaying){ clearInterval(window._stepInterval); return; }
    // highlight UI
    highlightStep(step);
    // play sequencer sounds if on
    playSequenceAtStep(step);
    step = (step+1)%steps;
  }, (60/bpm)/ (16/4) * 1000); // step duration in ms for 16th notes
}

function highlightStep(step){
  document.querySelectorAll('.sequencer').forEach(seq=>{
    seq.childNodes.forEach((s,i)=>{ s.style.opacity = (i===step)?1:0.85; if(i===step) s.style.boxShadow='0 0 18px rgba(124,58,237,0.22)'; else s.style.boxShadow='none'; });
  });
}

function playSequenceAtStep(step){
  const sKick = document.getElementById('seq-kick').children[step].classList.contains('on');
  const sSnare = document.getElementById('seq-snare').children[step].classList.contains('on');
  const sHat = document.getElementById('seq-hat').children[step].classList.contains('on');
  const sClap = document.getElementById('seq-clap').children[step].classList.contains('on');

  if(sKick) playKick(0,1);
  if(sSnare) playSnare(0,1);
  if(sHat) playHat(0,0.8);
  if(sClap) playClap(0,0.9);
}

// --- Simple: startTime tracking for scheduling recorded events to sequence ---
let startTime = Date.now();

// Play recorded events looped to tempo
function playRecordedLoop(){
  if(recordedEvents.length===0) return;
  const bpm = Number(tempoEl.value);
  const loopLengthMs = 2000; // default 2s loop for simple mapping — we can map recorded times to loop length
  // map recorded times proportionally into loop length
  const t0 = recordedEvents[0].t;
  recordedEvents.forEach(ev=>{
    const rel = (ev.t - t0) / 1000; // seconds
    // map rel modulo loop length
    const when = (rel % (loopLengthMs/1000));
    if(ev.type==='piano') playPianoNote(midiToFreq(ev.midi), when);
    if(ev.type==='drum'){
      if(ev.drum==='kick') playKick(when);
      if(ev.drum==='snare') playSnare(when);
      if(ev.drum==='hat') playHat(when);
      if(ev.drum==='clap') playClap(when);
    }
  });
}

// Hook play button to both sequencer and recorded loop
playBtn.addEventListener('click', ()=>{
  if(recordedEvents.length>0){ // play both
    // start a simple loop using setInterval with tempo
    if(window._recordLoop) clearInterval(window._recordLoop);
    const bpm = Number(tempoEl.value);
    // We'll trigger playRecordedLoop every 2 seconds to keep it simple
    playRecordedLoop();
    window._recordLoop = setInterval(()=>playRecordedLoop(), 2000);
  }
  start();
});
stopBtn.addEventListener('click', ()=>{ if(window._recordLoop) clearInterval(window._recordLoop); stop(); });

// download/import session JSON
document.getElementById('downloadJSON').addEventListener('click', ()=>{
  const data = { tempo: tempoEl.value, recorded: recordedEvents, seq:{kick:getSeqState('seq-kick'), snare:getSeqState('seq-snare'), hat:getSeqState('seq-hat'), clap:getSeqState('seq-clap') } };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'session.json'; a.click(); URL.revokeObjectURL(url);
});

function getSeqState(id){ return Array.from(document.getElementById(id).children).map(c=>c.classList.contains('on')); }

const fileInput = document.getElementById('fileInput');
document.getElementById('importJSON').addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = (ev)=>{
    try{ const data = JSON.parse(ev.target.result); tempoEl.value = data.tempo || 120; if(data.seq){ setSeq('seq-kick', data.seq.kick); setSeq('seq-snare', data.seq.snare); setSeq('seq-hat', data.seq.hat); setSeq('seq-clap', data.seq.clap); } if(data.recorded) recordedEvents = data.recorded; alert('Session imported'); }catch(err){ alert('Invalid JSON'); }
  }; reader.readAsText(f);
});
function setSeq(id, arr){ if(!arr) return; const el = document.getElementById(id); el.childNodes.forEach((c,i)=>{ c.classList.toggle('on', !!arr[i]); }); }

// metronome
let metSoundOsc=null; document.getElementById('metBtn').addEventListener('click', ()=>{ metro = !metro; document.getElementById('metBtn').classList.toggle('active', metro); if(metro) startMetronome(); });

let metInterval=null;
function startMetronome(){ if(metInterval) clearInterval(metInterval); const bpm = Number(tempoEl.value); metInterval = setInterval(()=>{ const o = ctx.createOscillator(); const g = ctx.createGain(); o.frequency.value = 1000; g.gain.setValueAtTime(0.001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.8, ctx.currentTime+0.001); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.12); o.connect(g); g.connect(masterGain); o.start(); o.stop(ctx.currentTime+0.13); }, (60/bpm)*1000); }

// small helpers
function getSeqStateBool(id, step){ return document.getElementById(id).children[step].classList.contains('on'); }

// Basic UI polish: make steps toggle with spacebar while focused
window.addEventListener('load', ()=>{
  // attach click/keyboard helpers
});

</script>
</body>
</html>
