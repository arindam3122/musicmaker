<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mobile Music Mixer</title>

<style>
:root{
  --accent:#6c63ff;
  --accent2:#00c2a8;
  --bg:#f5f8ff;
  --card:#ffffff;
  --text:#0b1320;
  --muted:#7b8a99;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:920px;
  margin:auto;
  padding:16px;
}
h1{text-align:center;margin:12px 0}
.subtitle{
  text-align:center;
  color:var(--muted);
  font-size:14px;
  margin-bottom:20px;
}
.card{
  background:var(--card);
  border-radius:20px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 10px 30px rgba(30,40,60,.08);
}
.card h3{margin-top:0}

.btn{
  background:var(--accent);
  color:#fff;
  border:0;
  padding:12px 18px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
}
.btn.secondary{
  background:#eef2ff;
  color:#223;
}
.btn.ghost{
  background:#fff;
  border:1px solid #ddd;
  color:var(--accent);
}
.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.small{
  font-size:13px;
  color:var(--muted);
}

.file-wrap{
  display:flex;
  align-items:center;
  gap:12px;
}
.file-btn{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#fff;
  padding:12px 16px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
}
.file-name{
  font-size:14px;
  color:var(--muted);
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
input[type=file]{display:none}

.meter{
  width:100%;
  height:10px;
  background:#e9eef7;
  border-radius:10px;
  overflow:hidden;
  margin-top:10px;
}
.meter span{
  display:block;
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  transition:width .1s linear;
}

/* --- MODAL --- */
.modal-overlay{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal{
  background:#fff;
  padding:25px;
  border-radius:18px;
  max-width:420px;
  width:90%;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  text-align:center;
}
.modal button{
  margin-top:14px;
  padding:12px 22px;
  border-radius:10px;
  border:0;
  background:var(--accent);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* --------------------------------------------- */
/*           CUSTOM AUDIO PLAYER UI              */
/* --------------------------------------------- */

.player {
  display: flex;
  align-items: center;
  gap: 10px;
  background: #ffffff;
  padding: 12px 14px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  margin-top: 12px;
}

.play-btn {
  background: var(--accent);
  color: #fff;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  font-size: 16px;
  cursor: pointer;
}

.time {
  font-size: 12px;
  color: #555;
  min-width: 38px;
  text-align: center;
}

.progress {
  flex: 1;
  background: #e6e6e6;
  height: 6px;
  border-radius: 6px;
  position: relative;
  cursor: pointer;
}

.progress .bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 6px;
}

.volume {
  width: 80px;
}

audio { display:none; }
.pill {
  display: inline-block;
  background: var(--accent);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  margin-left: 8px;
  min-width: 48px;
  text-align: center;
}

</style>
</head>

<body>

<!-- MODAL -->
<div class="modal-overlay" id="msgModal">
  <div class="modal">
    <div id="modalText">Message</div>
    <button onclick="closeModal()">OK</button>
  </div>
</div>

<div class="container">

<h1>Mobile Music Mixer</h1>
<p class="subtitle">Record voice with background music and export a real mix</p>

<!-- Upload -->
<div class="card">
<h3>1) Upload background</h3>

<div class="file-wrap">
  <label class="file-btn">
    Choose File
    <input type="file" id="bgInput" accept="audio/*">
  </label>
  <div class="file-name" id="bgName">No file selected</div>
</div>

<!-- Custom Audio Player -->
<div class="player" id="bgPlayer">
  <button class="play-btn" data-target="bgAudio">▶</button>
  <span class="time current">0:00</span>
  <div class="progress"><div class="bar"></div></div>
  <span class="time duration">0:00</span>
  <input type="range" class="volume" min="0" max="1" step="0.01" value="1">
</div>

<audio id="bgAudio"></audio>

<div style="margin-top:15px">
<label>Background Volume: </label>
<input type="range" id="bgVolume" min="0" max="1" value="0.8" step="0.01">
<span id="bgVolumeValue" class="pill">80%</span>


</div>
</div>

<!-- Record -->
<div class="card">
<h3>2) Record voice</h3>

<div class="row">
  <button class="btn" id="recordBtn">Start Recording</button>
  <button class="btn secondary" id="stopBtn">Stop</button>
</div>

<div class="small" style="margin-top:8px">
  Status: <strong id="status">idle</strong>
</div>

<div class="meter">
  <span id="meterFill"></span>
</div>
</div>

<!-- Mix -->
<div class="card">
<h3>3) Mix & Download</h3>

<div class="row">
  <button class="btn" id="mixBtn">Create Mix</button>
  <button class="btn ghost" id="playMixBtn">Play</button>
  <a class="btn" id="download" style="display:none">Download</a>
</div>

<!-- Custom Player for final mix -->
<div class="player" id="mixPlayer">
  <button class="play-btn" data-target="mixAudio">▶</button>
  <span class="time current">0:00</span>
  <div class="progress"><div class="bar"></div></div>
  <span class="time duration">0:00</span>
  <input type="range" class="volume" min="0" max="1" step="0.01" value="1">
</div>

<audio id="mixAudio"></audio>
</div>

</div>

<script>
function showMessage(msg){
  document.getElementById("modalText").textContent = msg;
  document.getElementById("msgModal").style.display = "flex";
}
function closeModal(){
  document.getElementById("msgModal").style.display = "none";
}

const bgInput=document.getElementById('bgInput');
const bgName=document.getElementById('bgName');
const bgAudio=document.getElementById('bgAudio');
const bgVolume=document.getElementById('bgVolume');

const recordBtn=document.getElementById('recordBtn');
const stopBtn=document.getElementById('stopBtn');
const statusEl=document.getElementById('status');
const meterFill=document.getElementById('meterFill');

const mixBtn=document.getElementById('mixBtn');
const mixAudio=document.getElementById('mixAudio');
const playMixBtn=document.getElementById('playMixBtn');
const download=document.getElementById('download');

let bgFile, recorder, chunks=[], stream;
let audioCtx, analyser, meterRAF;

/* Update background volume live */
bgVolume.oninput = () => { 
  bgAudio.volume = bgVolume.value;
  const percent = Math.round(bgVolume.value * 100);
  document.getElementById("bgVolumeValue").textContent = percent + "%";
};



/* Upload */
bgInput.onchange=e=>{
  bgFile=e.target.files[0];
  if(bgFile){
    bgName.textContent=bgFile.name;
    bgAudio.src=URL.createObjectURL(bgFile);
    showMessage("Background music loaded successfully!");
  }
};

/* Recording meter */
function startMeter(stream){
  audioCtx=new AudioContext();
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  const source=audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);

  const data=new Uint8Array(analyser.frequencyBinCount);
  const draw=()=>{
    analyser.getByteFrequencyData(data);
    let max=Math.max(...data);
    meterFill.style.width=Math.min(100,(max/255)*100)+"%";
    meterRAF=requestAnimationFrame(draw);
  };
  draw();
}
function stopMeter(){
  cancelAnimationFrame(meterRAF);
  meterFill.style.width='0%';
  if(audioCtx) audioCtx.close();
}

/* Record */
recordBtn.onclick=async()=>{
  if(!bgFile){
    showMessage("Please upload background music first!");
    return;
  }

  stream = await navigator.mediaDevices.getUserMedia({
    audio: {
      noiseSuppression: true,
      echoCancellation: true,
      autoGainControl: true,
      channelCount: 1,
      sampleRate: 48000
    }
  });

  recorder=new MediaRecorder(stream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);

  bgAudio.volume = bgVolume.value;
  bgAudio.currentTime=0;
  await bgAudio.play();

  recorder.start();
  statusEl.textContent='recording';
  startMeter(stream);

  showMessage("Recording started (Noise reduction ON)");
};

stopBtn.onclick=()=>{
  if(recorder && recorder.state==='recording'){
    recorder.stop();
    stream.getTracks().forEach(t=>t.stop());
    bgAudio.pause();
    stopMeter();
    statusEl.textContent='stopped';
    showMessage("Recording stopped!");
  }
};

/* Mixing */
mixBtn.onclick=async()=>{
  if(!bgFile){
    showMessage("Please upload a background audio file!");
    return;
  }
  if(!chunks.length){
    showMessage("Please record your voice before mixing!");
    return;
  }

  mixBtn.disabled=true;
  mixBtn.textContent='Mixing...';

  showMessage("Mixing... please wait");

  const voiceBlob=new Blob(chunks,{type:chunks[0].type});
  const finalBlob=await mixAudioFiles(bgFile,voiceBlob);

  const url=URL.createObjectURL(finalBlob);
  mixAudio.src=url;
  download.href=url;
  download.download='final_mix.wav';
  download.style.display='inline-flex';

  mixBtn.disabled=false;
  mixBtn.textContent='Create Mix';

  showMessage("Your mix is ready!");
};

playMixBtn.onclick=()=>{
  if(!mixAudio.src){
    showMessage("Please create a mix first!");
    return;
  }
  mixAudio.play();
  showMessage("Playing your mix");
};

/* Audio mixing engine */
async function mixAudioFiles(bgFile,voiceBlob){
  const [bgAB,vAB]=await Promise.all([toAB(bgFile),toAB(voiceBlob)]);
  const ctx=new AudioContext();
  const bg=await ctx.decodeAudioData(bgAB.slice(0));
  const v=await ctx.decodeAudioData(vAB.slice(0));
  ctx.close();

  const len=Math.max(bg.length,v.length);
  const sr=Math.max(bg.sampleRate,v.sampleRate);
  const off=new OfflineAudioContext(2,len,sr);

  const bgSrc=off.createBufferSource();
  bgSrc.buffer=bg;
  const bgGain=off.createGain();
  bgGain.gain.value=parseFloat(bgVolume.value);
  bgSrc.connect(bgGain).connect(off.destination);

  const vSrc=off.createBufferSource();
  vSrc.buffer=v;
  vSrc.connect(off.destination);

  bgSrc.start(0);
  vSrc.start(0);

  const rendered=await off.startRendering();
  return encodeWAV(rendered);
}

function toAB(data){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result);
    fr.readAsArrayBuffer(data);
  });
}

/* WAV encoder */
function encodeWAV(buf){
  const ch=buf.numberOfChannels;
  const sr=buf.sampleRate;
  const ab=new ArrayBuffer(44+buf.length*ch*2);
  const v=new DataView(ab);

  const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};
  w(0,'RIFF');v.setUint32(4,36+buf.length*ch*2,true);w(8,'WAVE');
  w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);
  v.setUint16(22,ch,true);v.setUint32(24,sr,true);
  v.setUint32(28,sr*ch*2,true);v.setUint16(32,ch*2,true);
  v.setUint16(34,16,true);w(36,'data');
  v.setUint32(40,buf.length*ch*2,true);

  let off=44;
  for(let i=0;i<buf.length;i++){
    for(let c=0;c<ch;c++){
      let s=Math.max(-1,Math.min(1,buf.getChannelData(c)[i]));
      v.setInt16(off,s<0?s*0x8000:s*0x7fff,true);
      off+=2;
    }
  }
  return new Blob([v],{type:'audio/wav'});
}

/* =================================================== */
/* INITIALIZE CUSTOM AUDIO PLAYERS                     */
/* =================================================== */

function initPlayer(playerId, audioId) {
  const player = document.getElementById(playerId);
  const audio = document.getElementById(audioId);

  const playBtn = player.querySelector(".play-btn");
  const currentTimeEl = player.querySelector(".current");
  const durationEl = player.querySelector(".duration");
  const progress = player.querySelector(".progress");
  const bar = player.querySelector(".bar");
  const volume = player.querySelector(".volume");

  audio.onloadedmetadata = () => {
    durationEl.textContent = formatTime(audio.duration);
  };

  playBtn.onclick = () => {
    if (audio.paused) {
      audio.play();
      playBtn.textContent = "⏸";
    } else {
      audio.pause();
      playBtn.textContent = "▶";
    }
  };

  audio.ontimeupdate = () => {
    const percent = (audio.currentTime / audio.duration) * 100;
    bar.style.width = percent + "%";
    currentTimeEl.textContent = formatTime(audio.currentTime);
  };

  progress.onclick = (e) => {
    const rect = progress.getBoundingClientRect();
    const offset = e.clientX - rect.left;
    const percent = offset / rect.width;
    audio.currentTime = percent * audio.duration;
  };

  volume.oninput = () => {
    audio.volume = volume.value;
  };
}

function formatTime(sec) {
  sec = Math.floor(sec);
  let m = Math.floor(sec / 60);
  let s = sec % 60;
  return m + ":" + (s < 10 ? "0" + s : s);
}

initPlayer("bgPlayer", "bgAudio");
initPlayer("mixPlayer", "mixAudio");

</script>

</body>
</html>
